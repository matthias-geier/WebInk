#!/usr/bin/env ruby

require 'webink/r'
require 'webink'

config = nil

begin
  config = Ink::Beauty.new.load_config
rescue Exception => bang
  puts "Error while loading config: #{bang}."
end

require "#{config[:db_type]}"
require "#{config[:db_type]}_adapter"

model_classes = Dir.open("./models").reduce([]) do |acc, model|
  load "./models/#{model}" if model =~ /\.rb$/
  acc << $1.camelize.constantize if model =~ /^(.*)\.rb$/
  acc
end

begin
  Ink::Database.create(config)
  db = Ink::Database.database
  db_tables = db.tables

  if ARGV[0] == "drop"
    puts "Dropping old tables..."
    db_tables.each do |t|
      puts "...#{t}"
      db.query "DROP TABLE #{t};"
    end
  end

  puts "Creating new tables..."
  model_classes.each do |m|
    puts "...for class: #{m.name}:"
    c = m.create
    puts c
    c.each do |exec|
      begin
        db.query exec
      rescue => ex
        puts ex
      end
    end
  end
rescue Exception => bang
  puts "SQLError: #{bang}."
end
